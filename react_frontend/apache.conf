# 2025-01-27: Apache configuration for dirReactFinal React frontend
# Configuration optimized for Single Page Application (SPA)

# Server configuration
ServerName localhost
ServerAdmin webmaster@dirfinal.com
ServerTokens Prod
ServerSignature Off

# Load required modules
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule headers_module modules/mod_headers.so
LoadModule expires_module modules/mod_expires.so
LoadModule deflate_module modules/mod_deflate.so

# MPM Event configuration for performance
<IfModule mpm_event_module>
    StartServers             2
    MinSpareThreads         10
    MaxSpareThreads         20
    ThreadLimit            64
    ThreadsPerChild         25
    MaxRequestWorkers      500
    MaxConnectionsPerChild   0
    ServerLimit            64
</IfModule>

# Main server configuration
Listen 3000

# Document root
DocumentRoot "/usr/local/apache2/htdocs"

# Directory configuration
<Directory "/usr/local/apache2/htdocs">
    Options -Indexes +FollowSymLinks
    AllowOverride All
    Require all granted
    
    # SPA routing - redirect all requests to index.html
    RewriteEngine On
    RewriteBase /
    
    # Handle static files first
    RewriteCond %{REQUEST_FILENAME} -f
    RewriteRule ^ - [L]
    
    # Handle API requests (should be proxied to Django)
    RewriteCond %{REQUEST_URI} ^/api/
    RewriteRule ^ - [L]
    
    # All other requests go to index.html for SPA routing
    RewriteRule ^ index.html [L]
    
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Cache control for static assets
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, immutable"
    </FilesMatch>
    
    # Cache control for HTML files
    <FilesMatch "\.(html|htm)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 hour"
        Header set Cache-Control "public, must-revalidate"
    </FilesMatch>
    
    # Cache control for JSON files
    <FilesMatch "\.json$">
        ExpiresActive On
        ExpiresDefault "access plus 1 day"
        Header set Cache-Control "public, must-revalidate"
    </FilesMatch>
</Directory>

# MIME types
<IfModule mod_mime.c>
    AddType application/javascript .js
    AddType text/css .css
    AddType image/svg+xml .svg
    AddType application/font-woff .woff
    AddType application/font-woff2 .woff2
    AddType application/json .json
</IfModule>

# Logging configuration
LogLevel warn
ErrorLog /usr/local/apache2/logs/error_log
CustomLog /usr/local/apache2/logs/access_log combined

# Performance optimization
EnableSendfile On
EnableMMAP On
FileETag None

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    
    # Don't compress already compressed files
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|rar|zip|exe|flv|mov|wma|mp3|avi|swf|mp?g|mp4|webm|webp)$ no-gzip dont-vary
    SetEnvIfNoCase Request_URI \.(?:pdf|doc|docx|xls|xlsx|ppt|pptx)$ no-gzip dont-vary
</IfModule>

# Security configuration
<IfModule mod_headers.c>
    # Content Security Policy for React app
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:; frame-ancestors 'none';"
    
    # Additional security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Health check endpoint
<Location "/health">
    SetHandler default-handler
    Require all granted
</Location>

# Custom error pages
ErrorDocument 404 /index.html
ErrorDocument 500 /index.html
