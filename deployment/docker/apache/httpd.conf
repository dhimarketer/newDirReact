# 2025-01-27: Production Apache configuration for dirReactFinal
# Main Apache configuration with security, performance, and proxy settings

# Server configuration
ServerName dirfinal.com
ServerAdmin webmaster@dirfinal.com
ServerTokens Prod
ServerSignature Off

# Load required modules
LoadModule mpm_event_module modules/mod_mpm_event.so
LoadModule dir_module modules/mod_dir.so
LoadModule mime_module modules/mod_mime.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule headers_module modules/mod_headers.so
LoadModule expires_module modules/mod_expires.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_balancer_module modules/mod_proxy_balancer.so
LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule status_module modules/mod_status.so
LoadModule info_module modules/mod_info.so

# MPM Event configuration for performance
<IfModule mpm_event_module>
    StartServers             3
    MinSpareThreads         25
    MaxSpareThreads         75
    ThreadLimit            128
    ThreadsPerChild         25
    MaxRequestWorkers     1000
    MaxConnectionsPerChild   0
    ServerLimit            128
</IfModule>

# Main server configuration
Listen 80
Listen 443

# Document root
DocumentRoot "/usr/local/apache2/htdocs"

# Directory configuration
<Directory "/usr/local/apache2/htdocs">
    Options -Indexes +FollowSymLinks
    AllowOverride All
    Require all granted
    
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Cache control for static assets
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 year"
        Header set Cache-Control "public, immutable"
    </FilesMatch>
    
    # Cache control for HTML files
    <FilesMatch "\.(html|htm)$">
        ExpiresActive On
        ExpiresDefault "access plus 1 hour"
        Header set Cache-Control "public, must-revalidate"
    </FilesMatch>
</Directory>

# Static files directory
<Directory "/var/www/static">
    Options -Indexes +FollowSymLinks
    AllowOverride None
    Require all granted
    
    # Cache control for Django static files
    ExpiresActive On
    ExpiresDefault "access plus 1 year"
    Header set Cache-Control "public, immutable"
</Directory>

# Media files directory
<Directory "/var/www/media">
    Options -Indexes +FollowSymLinks
    AllowOverride None
    Require all granted
    
    # Cache control for media files
    ExpiresActive On
    ExpiresDefault "access plus 1 month"
    Header set Cache-Control "public, must-revalidate"
</Directory>

# Logging configuration
LogLevel warn
ErrorLog /usr/local/apache2/logs/error_log
CustomLog /usr/local/apache2/logs/access_log combined

# Performance optimization
EnableSendfile On
EnableMMAP On
FileETag None

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    
    # Don't compress already compressed files
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|rar|zip|exe|flv|mov|wma|mp3|avi|swf|mp?g|mp4|webm|webp)$ no-gzip dont-vary
    SetEnvIfNoCase Request_URI \.(?:pdf|doc|docx|xls|xlsx|ppt|pptx)$ no-gzip dont-vary
</IfModule>

# Include additional configuration files
Include conf/extra/*.conf

# Health check endpoint
<Location "/health">
    ProxyPass http://localhost:8000/health/
    ProxyPassReverse http://localhost:8000/health/
</Location>

# Security configuration
<IfModule mod_headers.c>
    # HSTS (HTTP Strict Transport Security)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Content Security Policy
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https:; connect-src 'self' https:; frame-ancestors 'none';"
</IfModule>

# Rate limiting (if mod_ratelimit is available)
<IfModule mod_ratelimit.c>
    <Location "/api/">
        SetOutputFilter RATE_LIMIT
        SetEnv rate-limit 400
    </Location>
</IfModule>

# Include SSL configuration
Include conf/extra/ssl.conf
