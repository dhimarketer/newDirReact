# 2025-01-27: SSL configuration for dirReactFinal Apache server
# SSL/TLS configuration with security best practices

# SSL Configuration
<IfModule mod_ssl.c>
    # SSL Engine
    SSLEngine on
    
    # SSL Protocol Configuration
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLHonorCipherOrder on
    SSLCompression off
    
    # SSL Cipher Suite
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    
    # SSL Session Configuration
    SSLSessionCache "shmcb:/usr/local/apache2/logs/ssl_scache(512000)"
    SSLSessionCacheTimeout 300
    
    # SSL Certificate Files
    SSLCertificateFile "/usr/local/apache2/ssl/cert.pem"
    SSLCertificateKeyFile "/usr/local/apache2/ssl/key.pem"
    SSLCertificateChainFile "/usr/local/apache2/ssl/chain.pem"
    
    # OCSP Stapling
    SSLUseStapling on
    SSLStaplingCache "shmcb:/usr/local/apache2/logs/stapling_cache(128000)"
    
    # Security Headers for SSL
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    
    # SSL Virtual Host
    <VirtualHost *:443>
        ServerName dirfinal.com
        ServerAlias www.dirfinal.com
        DocumentRoot "/usr/local/apache2/htdocs"
        
        # Proxy configuration for Django backend
        ProxyPreserveHost On
        
        # API endpoints
        ProxyPass /api/ http://django_backend:8000/api/
        ProxyPassReverse /api/ http://django_backend:8000/api/
        
        # Admin interface
        ProxyPass /admin/ http://django_backend:8000/admin/
        ProxyPassReverse /admin/ http://django_backend:8000/admin/
        
        # Static files
        Alias /static/ /var/www/static/
        Alias /media/ /var/www/media/
        
        # Frontend routes (SPA support)
        ProxyPass / http://react_frontend:3000/
        ProxyPassReverse / http://react_frontend:3000/
        
        # Health check
        ProxyPass /health/ http://django_backend:8000/health/
        ProxyPassReverse /health/ http://django_backend:8000/health/
        
        # Logging
        ErrorLog /usr/local/apache2/logs/ssl_error_log
        CustomLog /usr/local/apache2/logs/ssl_access_log combined
        
        # Directory configuration
        <Directory "/var/www/static">
            Require all granted
            Options -Indexes +FollowSymLinks
        </Directory>
        
        <Directory "/var/www/media">
            Require all granted
            Options -Indexes +FollowSymLinks
        </Directory>
        
        # Security headers
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options DENY
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Referrer-Policy "strict-origin-when-cross-origin"
        Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
        
        # Cache control
        <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
            ExpiresActive On
            ExpiresDefault "access plus 1 year"
            Header set Cache-Control "public, immutable"
        </FilesMatch>
        
        <FilesMatch "\.(html|htm)$">
            ExpiresActive On
            ExpiresDefault "access plus 1 hour"
            Header set Cache-Control "public, must-revalidate"
        </FilesMatch>
    </VirtualHost>
</IfModule>

# HTTP to HTTPS redirect
<VirtualHost *:80>
    ServerName dirfinal.com
    ServerAlias www.dirfinal.com
    
    # Redirect all HTTP traffic to HTTPS
    Redirect permanent / https://dirfinal.com/
    
    # Logging
    ErrorLog /usr/local/apache2/logs/http_error_log
    CustomLog /usr/local/apache2/logs/http_access_log combined
</VirtualHost>
